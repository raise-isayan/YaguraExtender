package yagura.view;

import burp.BurpExtension;
import extension.burp.BurpConfig;
import extension.burp.FilterProperty;
import extension.burp.FilterWebSocketProperty;
import extension.helpers.ConvertUtil;
import extension.view.base.JavaSyntaxDocument;
import extension.view.layout.VerticalFlowLayout;
import javax.swing.text.Document;
import javax.swing.text.EditorKit;
import javax.swing.text.StyledEditorKit;

/**
 *
 * @author isayan
 */
public class FilterWebSocketPanel extends javax.swing.JPanel {

    /**
     * Creates new form NewJPanel
     */
    public FilterWebSocketPanel() {
        initComponents();
        customizeComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        tabbetFilter = new javax.swing.JTabbedPane();
        pnlSettings = new javax.swing.JPanel();
        pnlEast = new javax.swing.JPanel();
        pnlListenerPort = new javax.swing.JPanel();
        lblListenerPort = new javax.swing.JLabel();
        txtLiistenerPort = new javax.swing.JTextField();
        pnlCenter = new javax.swing.JPanel();
        pnlFilterByRequest = new javax.swing.JPanel();
        chkShowOnlyinscopeItem = new javax.swing.JCheckBox();
        chkHideOutgoingMessage = new javax.swing.JCheckBox();
        chkHideIncomingMessage = new javax.swing.JCheckBox();
        chkShowOnlyEditedMessage = new javax.swing.JCheckBox();
        pnlWebsocketFilterSearchItem = new javax.swing.JPanel();
        chkMsgRegExp = new javax.swing.JCheckBox();
        chkMsgIgnoreCase = new javax.swing.JCheckBox();
        txtMessage = new javax.swing.JTextField();
        lblMessage = new javax.swing.JLabel();

        setLayout(new java.awt.BorderLayout());

        pnlSettings.setLayout(new java.awt.BorderLayout());

        pnlEast.setLayout(new java.awt.BorderLayout());

        pnlListenerPort.setBorder(javax.swing.BorderFactory.createTitledBorder("Filter by listener "));
        pnlListenerPort.setLayout(new java.awt.BorderLayout());

        lblListenerPort.setText("Port");
        pnlListenerPort.add(lblListenerPort, java.awt.BorderLayout.WEST);
        pnlListenerPort.add(txtLiistenerPort, java.awt.BorderLayout.CENTER);

        pnlEast.add(pnlListenerPort, java.awt.BorderLayout.SOUTH);

        pnlSettings.add(pnlEast, java.awt.BorderLayout.EAST);

        pnlCenter.setLayout(new java.awt.BorderLayout());

        pnlFilterByRequest.setBorder(javax.swing.BorderFactory.createTitledBorder("Filter by request type"));
        pnlFilterByRequest.setMaximumSize(new java.awt.Dimension(172, 100));
        pnlFilterByRequest.setMinimumSize(new java.awt.Dimension(172, 100));
        pnlFilterByRequest.setPreferredSize(new java.awt.Dimension(172, 100));
        pnlFilterByRequest.setLayout(new javax.swing.BoxLayout(pnlFilterByRequest, javax.swing.BoxLayout.Y_AXIS));

        chkShowOnlyinscopeItem.setText("Show only in-scope items");
        pnlFilterByRequest.add(chkShowOnlyinscopeItem);

        chkHideOutgoingMessage.setText("Hide outgoing message");
        pnlFilterByRequest.add(chkHideOutgoingMessage);

        chkHideIncomingMessage.setText("Hide incoming message");
        pnlFilterByRequest.add(chkHideIncomingMessage);

        chkShowOnlyEditedMessage.setText("Show only edited message");
        pnlFilterByRequest.add(chkShowOnlyEditedMessage);

        pnlCenter.add(pnlFilterByRequest, java.awt.BorderLayout.NORTH);

        pnlWebsocketFilterSearchItem.setBorder(javax.swing.BorderFactory.createTitledBorder("Filter by Search Item"));
        pnlWebsocketFilterSearchItem.setMinimumSize(new java.awt.Dimension(663, 400));

        chkMsgRegExp.setText("RegExp");

        chkMsgIgnoreCase.setText("IgnoreCase");

        lblMessage.setText("Message:");

        javax.swing.GroupLayout pnlWebsocketFilterSearchItemLayout = new javax.swing.GroupLayout(pnlWebsocketFilterSearchItem);
        pnlWebsocketFilterSearchItem.setLayout(pnlWebsocketFilterSearchItemLayout);
        pnlWebsocketFilterSearchItemLayout.setHorizontalGroup(
            pnlWebsocketFilterSearchItemLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlWebsocketFilterSearchItemLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lblMessage, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtMessage, javax.swing.GroupLayout.PREFERRED_SIZE, 358, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(chkMsgRegExp)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(chkMsgIgnoreCase)
                .addContainerGap(51, Short.MAX_VALUE))
        );
        pnlWebsocketFilterSearchItemLayout.setVerticalGroup(
            pnlWebsocketFilterSearchItemLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlWebsocketFilterSearchItemLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlWebsocketFilterSearchItemLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblMessage)
                    .addComponent(txtMessage, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(chkMsgRegExp)
                    .addComponent(chkMsgIgnoreCase))
                .addGap(395, 395, 395))
        );

        pnlCenter.add(pnlWebsocketFilterSearchItem, java.awt.BorderLayout.CENTER);

        pnlSettings.add(pnlCenter, java.awt.BorderLayout.CENTER);

        tabbetFilter.addTab("Settings", pnlSettings);

        add(tabbetFilter, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JCheckBox chkHideIncomingMessage;
    private javax.swing.JCheckBox chkHideOutgoingMessage;
    private javax.swing.JCheckBox chkMsgIgnoreCase;
    private javax.swing.JCheckBox chkMsgRegExp;
    private javax.swing.JCheckBox chkShowOnlyEditedMessage;
    private javax.swing.JCheckBox chkShowOnlyinscopeItem;
    private javax.swing.JLabel lblListenerPort;
    private javax.swing.JLabel lblMessage;
    private javax.swing.JPanel pnlCenter;
    private javax.swing.JPanel pnlEast;
    private javax.swing.JPanel pnlFilterByRequest;
    private javax.swing.JPanel pnlListenerPort;
    private javax.swing.JPanel pnlSettings;
    private javax.swing.JPanel pnlWebsocketFilterSearchItem;
    private javax.swing.JTabbedPane tabbetFilter;
    private javax.swing.JTextField txtLiistenerPort;
    private javax.swing.JTextField txtMessage;
    // End of variables declaration//GEN-END:variables

    private final EditorKit javaStyleEditorKit = new StyledEditorKit() {
        @Override
        public Document createDefaultDocument() {
            return new JavaSyntaxDocument();
        }
    };

    private final FilterAnnotationPanel pnlAnnotation = new FilterAnnotationPanel();

    private final javax.swing.JPanel pnlBambda = new javax.swing.JPanel();
    private final javax.swing.JScrollPane scrollBabda = new javax.swing.JScrollPane();
    private final javax.swing.JEditorPane txtBambda = new javax.swing.JEditorPane();

    private void customizeComponents() {
        this.scrollBabda.setViewportView(this.txtBambda);

        this.txtBambda.setEditorKitForContentType("text/java", this.javaStyleEditorKit);
        this.txtBambda.setContentType("text/java");

        this.pnlBambda.setLayout(new java.awt.BorderLayout());
        this.scrollBabda.setViewportView(this.txtBambda);
        this.pnlBambda.add(scrollBabda, java.awt.BorderLayout.CENTER);
        this.tabbetFilter.addTab("Bambda", this.pnlBambda);

        this.pnlFilterByRequest.setLayout(new VerticalFlowLayout());
        this.pnlEast.add(this.pnlAnnotation, java.awt.BorderLayout.CENTER);

    }

    public void addTableChangeListener(javax.swing.event.ChangeListener listener) {
        this.tabbetFilter.addChangeListener(listener);
    }

    public void removeTableChangeListener(javax.swing.event.ChangeListener listener) {
        this.tabbetFilter.removeChangeListener(listener);
    }

    public boolean isFilterModeSettings() {
        return this.tabbetFilter.getSelectedIndex() == this.tabbetFilter.indexOfTab("Settings");
    }

    public void ConverToBambda(FilterProperty filter) {
        this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        this.txtBambda.setText(filter.build());
    }

    public void ImportBambda(FilterProperty.FilterCategory filterCategory) {
        String bambda = BurpConfig.getBambda(BurpExtension.api(), filterCategory);
        this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        this.txtBambda.setText(bambda);
    }

    public void setBambaMode(boolean bamba) {
        this.tabbetFilter.remove(this.pnlBambda);
        if (bamba) {
            this.tabbetFilter.addTab("Bambda", this.pnlBambda);
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Settings"));
        }
    }


    public void setProperty(FilterWebSocketProperty filterProp) {
        if (filterProp.getFilterMode() == FilterProperty.FilterMode.SETTING) {
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Settings"));
        } else {
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        }
        this.chkShowOnlyinscopeItem.setSelected(filterProp.isShowOnlyScopeItems());
        this.chkHideIncomingMessage.setSelected(filterProp.isHideIncomingMessage());
        this.chkHideOutgoingMessage.setSelected(filterProp.isHideOutgoingMessage());
        this.chkShowOnlyEditedMessage.setSelected(filterProp.isShowOnlyEditedMessage());

        this.txtMessage.setText(filterProp.getMessage());
        this.chkMsgRegExp.setSelected(filterProp.isMessageRegex());
        this.chkMsgIgnoreCase.setSelected(filterProp.isMessageIgnoreCase());
        this.txtBambda.setText(filterProp.getBambdaQuery());

        this.txtLiistenerPort.setText(filterProp.getListenerPort() > -1 ? Integer.toString(filterProp.getListenerPort()) : "");
        
        this.pnlAnnotation.setAnnotationProperty(filterProp);
    }

    public FilterProperty getProperty() {
        FilterProperty filterProp = new FilterProperty();
        filterProp.setFilterCategory(FilterProperty.FilterCategory.WEBSOCKET);
        if (this.isFilterModeSettings()) {
            filterProp.setFilterMode(FilterProperty.FilterMode.SETTING);
        } else {
            filterProp.setFilterMode(FilterProperty.FilterMode.BAMBDA);
        }
        filterProp.setShowOnlyScopeItems(this.chkShowOnlyinscopeItem.isSelected());
        filterProp.setHideIncomingMessage(this.chkHideIncomingMessage.isSelected());
        filterProp.setHideOutgoingMessage(this.chkHideOutgoingMessage.isSelected());
        filterProp.setShowOnlyEditedMessage(this.chkShowOnlyEditedMessage.isSelected());

        filterProp.setListenerPort(ConvertUtil.parseIntDefault(this.txtLiistenerPort.getText(), -1));
        
        this.pnlAnnotation.getAnnotationProperty(filterProp);

        filterProp.setMessage(this.txtMessage.getText());
        filterProp.setMessageRegex(this.chkMsgRegExp.isSelected());
        filterProp.setMessageIgnoreCase(this.chkMsgIgnoreCase.isSelected());
        filterProp.setBambda(this.txtBambda.getText());
        return filterProp;
    }

}
