package yagura.view;

import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JWSHeader;
import com.nimbusds.jose.JWSObject;
import com.nimbusds.jose.Payload;
import com.nimbusds.jose.crypto.ECDSASigner;
import com.nimbusds.jose.crypto.RSASSASigner;
import com.nimbusds.jwt.JWTClaimsSet;
import extend.util.external.jws.JWSUtil;
import extend.util.external.jws.WeakMACSigner;
import extension.helpers.json.JsonUtil;
import java.awt.SystemColor;
import java.text.ParseException;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import org.bouncycastle.openssl.PEMException;
import passive.JWSToken;

/**
 *
 * @author isayan
 */
public class JWSEditPanel extends javax.swing.JPanel {

    /**
     * Creates new form JWEView
     */
    public JWSEditPanel() {
        initComponents();
        customizeComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlJWT = new javax.swing.JPanel();
        pnlHeader = new javax.swing.JPanel();
        lblHeader = new javax.swing.JLabel();
        pnlPayload = new javax.swing.JPanel();
        lblPayload = new javax.swing.JLabel();
        pnlSecret = new javax.swing.JPanel();
        lblSecret = new javax.swing.JLabel();

        setLayout(new java.awt.BorderLayout());

        pnlJWT.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        pnlJWT.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlJWT.setPreferredSize(new java.awt.Dimension(100, 454));
        pnlJWT.setLayout(new java.awt.BorderLayout());

        pnlHeader.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlHeader.setPreferredSize(new java.awt.Dimension(100, 120));
        pnlHeader.setLayout(new java.awt.BorderLayout());

        lblHeader.setText("Header");
        pnlHeader.add(lblHeader, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlHeader, java.awt.BorderLayout.NORTH);

        pnlPayload.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlPayload.setPreferredSize(new java.awt.Dimension(100, 300));
        pnlPayload.setLayout(new java.awt.BorderLayout());

        lblPayload.setText("Payload");
        pnlPayload.add(lblPayload, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlPayload, java.awt.BorderLayout.CENTER);

        pnlSecret.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlSecret.setPreferredSize(new java.awt.Dimension(100, 120));
        pnlSecret.setLayout(new java.awt.BorderLayout());

        lblSecret.setText("Secret");
        pnlSecret.add(lblSecret, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlSecret, java.awt.BorderLayout.SOUTH);

        add(pnlJWT, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

//    final PropertyChangeListener propertyListener = new PropertyChangeListener() {
//        @Override
//        public void propertyChange(PropertyChangeEvent evt) {
//            ThemeUI.applyStyleTheme(txtHeaderJSON);
//            ThemeUI.applyStyleTheme(txtPayloadJSON);
//            ThemeUI.applyStyleTheme(txtSecretKey);
//        }
//    };

    final DocumentListener documentListener = new DocumentListener() {
        @Override
        public void insertUpdate(DocumentEvent e) {

        }

        @Override
        public void removeUpdate(DocumentEvent e) {

        }

        @Override
        public void changedUpdate(DocumentEvent e) {

        }

    };

//    private org.fife.ui.rtextarea.RTextScrollPane scrollHeaderJSON;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtHeaderJSON;
//
//    private org.fife.ui.rtextarea.RTextScrollPane scrollPayloadJSON;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtPayloadJSON;
//
//    private org.fife.ui.rtextarea.RTextScrollPane scrollSecretKey;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtSecretKey;

    private javax.swing.JScrollPane scrollHeaderJSON;
    private javax.swing.JTextArea txtHeaderJSON;

    private javax.swing.JScrollPane scrollPayloadJSON;
    private javax.swing.JTextArea txtPayloadJSON;

    private javax.swing.JScrollPane scrollSecretKey;
    private javax.swing.JTextArea txtSecretKey;

    private void customizeComponents() {
        /**
         * * UI design start **
         */

        /* Header */
        this.txtHeaderJSON = new javax.swing.JTextArea();
        this.scrollHeaderJSON = new javax.swing.JScrollPane(this.txtHeaderJSON);
        this.txtHeaderJSON.setWrapStyleWord(false);
//        this.txtHeaderJSON.setCodeFoldingEnabled(true);
//        this.txtHeaderJSON.setClearWhitespaceLinesEnabled(true);
//        this.txtHeaderJSON.setHighlightCurrentLine(false);
//        this.txtHeaderJSON.setCurrentLineHighlightColor(SystemColor.textHighlight);
//        this.txtHeaderJSON.setBackground(SystemColor.text);
        this.txtHeaderJSON.setEditable(true);
//        this.txtHeaderJSON.setSyntaxEditingStyle(SyntaxConstants.SYNTAX_STYLE_JSON);
//        this.txtHeaderJSON.getDocument().addDocumentListener(this.documentListener);

//        scrollURaw.setViewportView(txtURaw);
//        this.scrollHeaderJSON.setLineNumbersEnabled(false);
        this.pnlHeader.add(this.scrollHeaderJSON, java.awt.BorderLayout.CENTER);

        /* Payload */
        this.txtPayloadJSON = new javax.swing.JTextArea();
        this.scrollPayloadJSON = new javax.swing.JScrollPane(this.txtPayloadJSON);
        this.txtPayloadJSON.setWrapStyleWord(false);
//        this.txtPayloadJSON.setCodeFoldingEnabled(true);
//        this.txtPayloadJSON.setClearWhitespaceLinesEnabled(true);
//        this.txtPayloadJSON.setHighlightCurrentLine(false);
//        this.txtPayloadJSON.setCurrentLineHighlightColor(SystemColor.textHighlight);
        this.txtPayloadJSON.setBackground(SystemColor.text);
        this.txtPayloadJSON.setEditable(true);
//        this.txtPayloadJSON.setSyntaxEditingStyle(SyntaxConstants.SYNTAX_STYLE_JSON);
//        this.txtPayloadJSON.getDocument().addDocumentListener(this.documentListener);

//        scrollURaw.setViewportView(txtURaw);

        this.pnlPayload.add(this.scrollPayloadJSON, java.awt.BorderLayout.CENTER);

        /* Signature */
        this.txtSecretKey = new javax.swing.JTextArea();
        this.scrollSecretKey = new javax.swing.JScrollPane(this.txtSecretKey);
        this.txtSecretKey.setWrapStyleWord(false);

//        this.txtSecretKey.setCodeFoldingEnabled(true);
//        this.txtSecretKey.setClearWhitespaceLinesEnabled(true);
//        this.txtSecretKey.setHighlightCurrentLine(false);
//        this.txtSecretKey.setCurrentLineHighlightColor(SystemColor.textHighlight);
        this.txtSecretKey.setBackground(SystemColor.text);
        this.txtSecretKey.setEditable(true);
//        this.txtSecretKey.getDocument().addDocumentListener(this.documentListener);
//        scrollURaw.setViewportView(txtURaw);

//        this.scrollSecretKey.setLineNumbersEnabled(false);

        this.pnlSecret.add(this.scrollSecretKey, java.awt.BorderLayout.CENTER);

//        this.propertyListener.propertyChange(null);
//        ThemeUI.addPropertyChangeListener(propertyListener);

    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel lblHeader;
    private javax.swing.JLabel lblPayload;
    private javax.swing.JLabel lblSecret;
    private javax.swing.JPanel pnlHeader;
    private javax.swing.JPanel pnlJWT;
    private javax.swing.JPanel pnlPayload;
    private javax.swing.JPanel pnlSecret;
    // End of variables declaration//GEN-END:variables

    private boolean format = true;

    /**
     * @return the format
     */
    public boolean isFormat() {
        return this.format;
    }

    /**
     * @param format the format to set
     */
    public void setFormat(boolean format) {
        this.format = format;
    }

    public JWSHeader getHeader() throws ParseException {
        return JWSHeader.parse(this.txtHeaderJSON.getText());
    }

    public void setHeader(String value) {
        this.txtHeaderJSON.setText(value);
    }

    public void setHeaderJSON(String value, boolean pretty) {
        this.txtHeaderJSON.setText(JsonUtil.prettyJson(value, true));
    }

    public Payload getPayload() throws ParseException {
        return JWTClaimsSet.parse(this.txtPayloadJSON.getText()).toPayload();
    }

    public void setPayload(String value) {
        this.txtPayloadJSON.setText(value);
    }

    public void setPayloadJSON(String value, boolean pretty) {
        this.txtPayloadJSON.setText(JsonUtil.prettyJson(value, true));
    }
    
    public void setSecretKey(String value) {
        this.txtSecretKey.setText(value);
    }

    public String getSecretKey() {
        return this.txtSecretKey.getText();
    }

    public String sign() throws JOSEException {
        try {
            JWSHeader header = this.getHeader();
            JWSObject sign = null;
            if (WeakMACSigner.SUPPORTED_ALGORITHMS.contains(header.getAlgorithm())) {
                sign = JWSUtil.sign(header.getAlgorithm(), this.getHeader(), this.getPayload(), JWSUtil.toSecretKey(this.getSecretKey()));
            }
            else if (RSASSASigner.SUPPORTED_ALGORITHMS.contains(header.getAlgorithm())) {
                sign = JWSUtil.sign(header.getAlgorithm(), this.getHeader(), this.getPayload(), JWSUtil.toPrivateKey(this.getSecretKey()));
            }
            else if (ECDSASigner.SUPPORTED_ALGORITHMS.contains(header.getAlgorithm())) {
                sign = JWSUtil.sign(header.getAlgorithm(), this.getHeader(), this.getPayload(), JWSUtil.toECPrivateKey(this.getSecretKey()));
            }
            if (sign != null) {
                return sign.serialize();
            }
            throw new IllegalArgumentException("Not support:" + header.getAlgorithm());
        } catch (PEMException | ParseException ex) {
            throw new JOSEException(ex.getMessage(), ex);
        }
    }

    public void setJWS(JWSToken token) {
        this.setJWS(token, this.format);
    }

    public void setJWS(JWSToken token, boolean format) {
        this.txtHeaderJSON.setText(token.getHeaderJSON(format));
        this.txtPayloadJSON.setText(token.getPayloadJSON(format));
        this.txtSecretKey.setText(token.getSignature());
    }

    public void setLineWrap(boolean lineWrap) {
        this.txtHeaderJSON.setLineWrap(lineWrap);
        this.txtPayloadJSON.setLineWrap(lineWrap);
        this.txtSecretKey.setLineWrap(lineWrap);
    }

    void clearJWS() {
        this.txtHeaderJSON.setText("");
        this.txtPayloadJSON.setText("");
        this.txtSecretKey.setText("");
    }

}
