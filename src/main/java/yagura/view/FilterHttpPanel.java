package yagura.view;

import burp.BurpExtension;
import extension.burp.BurpConfig;
import extension.burp.FilterHTTPProperty;
import extension.burp.FilterProperty;
import extension.helpers.ConvertUtil;
import extension.view.base.JavaSyntaxDocument;
import extension.view.layout.VerticalFlowLayout;
import javax.swing.text.Document;
import javax.swing.text.EditorKit;
import javax.swing.text.StyledEditorKit;

/**
 *
 * @author isayan
 */
public class FilterHttpPanel extends javax.swing.JPanel {

    /**
     * Creates new form FilterHttpPanel
     */
    public FilterHttpPanel() {
        initComponents();
        customizeComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        tabbetFilter = new javax.swing.JTabbedPane();
        pnlSettings = new javax.swing.JPanel();
        pnlEast = new javax.swing.JPanel();
        pnlListenerPort = new javax.swing.JPanel();
        lblListenerPort = new javax.swing.JLabel();
        txtLiistenerPort = new javax.swing.JTextField();
        pnlCenter = new javax.swing.JPanel();
        pnlHttp = new javax.swing.JPanel();
        pnlHeader = new javax.swing.JPanel();
        pnlHttpFilterByRequest = new javax.swing.JPanel();
        chkShowOnlyinscopeItem = new javax.swing.JCheckBox();
        chkHideItemsWithoutResponses = new javax.swing.JCheckBox();
        chkShowOnlyParameterizedRequests = new javax.swing.JCheckBox();
        chkShowOnlyEditedMessage = new javax.swing.JCheckBox();

        setLayout(new java.awt.BorderLayout());

        pnlSettings.setLayout(new java.awt.BorderLayout());

        pnlEast.setLayout(new java.awt.BorderLayout());

        pnlListenerPort.setBorder(javax.swing.BorderFactory.createTitledBorder("Filter by listener "));
        pnlListenerPort.setLayout(new java.awt.BorderLayout());

        lblListenerPort.setText("Port");
        pnlListenerPort.add(lblListenerPort, java.awt.BorderLayout.WEST);
        pnlListenerPort.add(txtLiistenerPort, java.awt.BorderLayout.CENTER);

        pnlEast.add(pnlListenerPort, java.awt.BorderLayout.SOUTH);

        pnlSettings.add(pnlEast, java.awt.BorderLayout.EAST);

        pnlCenter.setLayout(new java.awt.BorderLayout());

        pnlHttp.setMinimumSize(new java.awt.Dimension(217, 300));
        pnlHttp.setName(""); // NOI18N
        pnlHttp.setPreferredSize(new java.awt.Dimension(500, 300));
        pnlHttp.setLayout(new java.awt.BorderLayout());
        pnlCenter.add(pnlHttp, java.awt.BorderLayout.CENTER);

        pnlHeader.setLayout(new java.awt.BorderLayout());

        pnlHttpFilterByRequest.setBorder(javax.swing.BorderFactory.createTitledBorder("Filter by request type"));
        pnlHttpFilterByRequest.setMaximumSize(new java.awt.Dimension(212, 100));
        pnlHttpFilterByRequest.setMinimumSize(new java.awt.Dimension(212, 100));
        pnlHttpFilterByRequest.setPreferredSize(new java.awt.Dimension(212, 100));
        pnlHttpFilterByRequest.setLayout(new javax.swing.BoxLayout(pnlHttpFilterByRequest, javax.swing.BoxLayout.Y_AXIS));

        chkShowOnlyinscopeItem.setText("Show only in-scope items");
        pnlHttpFilterByRequest.add(chkShowOnlyinscopeItem);

        chkHideItemsWithoutResponses.setText("Hide items without responses");
        pnlHttpFilterByRequest.add(chkHideItemsWithoutResponses);

        chkShowOnlyParameterizedRequests.setText("Show only parameterized requests");
        pnlHttpFilterByRequest.add(chkShowOnlyParameterizedRequests);

        chkShowOnlyEditedMessage.setText("Show only edited message");
        pnlHttpFilterByRequest.add(chkShowOnlyEditedMessage);

        pnlHeader.add(pnlHttpFilterByRequest, java.awt.BorderLayout.CENTER);

        pnlCenter.add(pnlHeader, java.awt.BorderLayout.NORTH);

        pnlSettings.add(pnlCenter, java.awt.BorderLayout.CENTER);

        tabbetFilter.addTab("Settings", pnlSettings);

        add(tabbetFilter, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JCheckBox chkHideItemsWithoutResponses;
    private javax.swing.JCheckBox chkShowOnlyEditedMessage;
    private javax.swing.JCheckBox chkShowOnlyParameterizedRequests;
    private javax.swing.JCheckBox chkShowOnlyinscopeItem;
    private javax.swing.JLabel lblListenerPort;
    private javax.swing.JPanel pnlCenter;
    private javax.swing.JPanel pnlEast;
    private javax.swing.JPanel pnlHeader;
    private javax.swing.JPanel pnlHttp;
    private javax.swing.JPanel pnlHttpFilterByRequest;
    private javax.swing.JPanel pnlListenerPort;
    private javax.swing.JPanel pnlSettings;
    private javax.swing.JTabbedPane tabbetFilter;
    private javax.swing.JTextField txtLiistenerPort;
    // End of variables declaration//GEN-END:variables

    private final EditorKit javaStyleEditorKit = new StyledEditorKit() {
        @Override
        public Document createDefaultDocument() {
            return new JavaSyntaxDocument();
        }
    };

    private final FilterAnnotationPanel pnlAnnotation = new FilterAnnotationPanel();
    private final FilterRequestResponsePanel pnlRequestResponse = new FilterRequestResponsePanel();

    private final javax.swing.JPanel pnlBambda = new javax.swing.JPanel();
    private final javax.swing.JScrollPane scrollBabda = new javax.swing.JScrollPane();
    private final javax.swing.JEditorPane txtBambda = new javax.swing.JEditorPane();

    private void customizeComponents() {
        this.scrollBabda.setViewportView(this.txtBambda);

        this.txtBambda.setEditorKitForContentType("text/java", this.javaStyleEditorKit);
        this.txtBambda.setContentType("text/java");

        this.pnlBambda.setLayout(new java.awt.BorderLayout());
        this.scrollBabda.setViewportView(this.txtBambda);
        this.pnlBambda.add(scrollBabda, java.awt.BorderLayout.CENTER);
        this.tabbetFilter.addTab("Bambda", this.pnlBambda);

        this.pnlHttpFilterByRequest.setLayout(new VerticalFlowLayout());
        this.pnlHttp.add(this.pnlRequestResponse, java.awt.BorderLayout.CENTER);
        this.pnlEast.add(this.pnlAnnotation, java.awt.BorderLayout.CENTER);

    }

    public void addTableChangeListener(javax.swing.event.ChangeListener listener) {
        this.tabbetFilter.addChangeListener(listener);
    }

    public void removeTableChangeListener(javax.swing.event.ChangeListener listener) {
        this.tabbetFilter.removeChangeListener(listener);
    }

    public boolean isFilterModeSettings() {
        return this.tabbetFilter.getSelectedIndex() == this.tabbetFilter.indexOfTab("Settings");
    }

    public void ConverToBambda(FilterProperty filter) {
        this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        this.txtBambda.setText(filter.build());
    }

    public void ImportBambda(FilterProperty.FilterCategory filterCategory) {
        String bambda = BurpConfig.getBambda(BurpExtension.api(), filterCategory);
        this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        this.txtBambda.setText(bambda);
    }

    public void setBambaMode(boolean bamba) {
        this.tabbetFilter.remove(this.pnlBambda);
        if (bamba) {
            this.tabbetFilter.addTab("Bambda", this.pnlBambda);
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Settings"));
        }
    }

    public void setProperty(FilterHTTPProperty filterProp) {
        if (filterProp.getFilterMode() == FilterProperty.FilterMode.SETTING) {
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Settings"));
        } else {
            this.tabbetFilter.setSelectedIndex(this.tabbetFilter.indexOfTab("Bambda"));
        }
        this.chkShowOnlyinscopeItem.setSelected(filterProp.isShowOnlyScopeItems());
        this.chkHideItemsWithoutResponses.setSelected(filterProp.isHideItemsWithoutResponses());
        this.chkShowOnlyParameterizedRequests.setSelected(filterProp.isShowOnlyParameterizedRequests());
        this.chkShowOnlyEditedMessage.setSelected(filterProp.isShowOnlyEditedMessage());

        this.txtLiistenerPort.setText(filterProp.getListenerPort() > -1 ? Integer.toString(filterProp.getListenerPort()) : "");
        
        this.txtBambda.setText(filterProp.getBambdaQuery());

        this.pnlAnnotation.setAnnotationProperty(filterProp);
    }

    public FilterProperty getProperty() {
        FilterProperty filterProp = new FilterProperty();
        filterProp.setFilterCategory(FilterProperty.FilterCategory.HTTP);
        if (this.isFilterModeSettings()) {
            filterProp.setFilterMode(FilterProperty.FilterMode.SETTING);
        } else {
            filterProp.setFilterMode(FilterProperty.FilterMode.BAMBDA);
        }
        filterProp.setShowOnlyScopeItems(this.chkShowOnlyinscopeItem.isSelected());
        filterProp.setHideItemsWithoutResponses(this.chkHideItemsWithoutResponses.isSelected());
        filterProp.setShowOnlyParameterizedRequests(this.chkShowOnlyParameterizedRequests.isSelected());
        filterProp.setShowOnlyEditedMessage(this.chkShowOnlyEditedMessage.isSelected());

        filterProp.setListenerPort(ConvertUtil.parseIntDefault(this.txtLiistenerPort.getText(), -1));

        this.pnlAnnotation.getAnnotationProperty(filterProp);

        filterProp.setBambda(this.txtBambda.getText());
        return filterProp;
    }

}
