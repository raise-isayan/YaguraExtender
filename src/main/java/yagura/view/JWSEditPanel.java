package yagura.view;

import com.google.gson.JsonSyntaxException;
import extension.helpers.jws.JWSUtil;
import extension.helpers.json.JsonUtil;
import extension.view.base.JSONDocument;
import java.awt.SystemColor;
import java.security.Key;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.SignatureException;
import javax.crypto.SecretKey;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import org.bouncycastle.openssl.PEMException;
import extension.helpers.jws.JWKToken;
import extension.helpers.jws.JWSToken;
import extension.helpers.jws.JsonToken;

/**
 *
 * @author isayan
 */
public class JWSEditPanel extends javax.swing.JPanel {

    /**
     * Creates new form JWEView
     */
    public JWSEditPanel() {
        initComponents();
        customizeComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlJWT = new javax.swing.JPanel();
        pnlHeader = new javax.swing.JPanel();
        lblHeader = new javax.swing.JLabel();
        pnlPayload = new javax.swing.JPanel();
        lblPayload = new javax.swing.JLabel();
        pnlSecret = new javax.swing.JPanel();
        pnlSecretStatus = new javax.swing.JPanel();
        lblSecret = new javax.swing.JLabel();
        tglBase64Url = new javax.swing.JToggleButton();

        setLayout(new java.awt.BorderLayout());

        pnlJWT.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        pnlJWT.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlJWT.setPreferredSize(new java.awt.Dimension(100, 454));
        pnlJWT.setLayout(new java.awt.BorderLayout());

        pnlHeader.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlHeader.setPreferredSize(new java.awt.Dimension(100, 120));
        pnlHeader.setLayout(new java.awt.BorderLayout());

        lblHeader.setText("Header");
        pnlHeader.add(lblHeader, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlHeader, java.awt.BorderLayout.NORTH);

        pnlPayload.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlPayload.setPreferredSize(new java.awt.Dimension(100, 300));
        pnlPayload.setLayout(new java.awt.BorderLayout());

        lblPayload.setText("Payload");
        pnlPayload.add(lblPayload, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlPayload, java.awt.BorderLayout.CENTER);

        pnlSecret.setMinimumSize(new java.awt.Dimension(0, 0));
        pnlSecret.setPreferredSize(new java.awt.Dimension(100, 120));
        pnlSecret.setLayout(new java.awt.BorderLayout());

        pnlSecretStatus.setLayout(new java.awt.BorderLayout());

        lblSecret.setText("Secret");
        pnlSecretStatus.add(lblSecret, java.awt.BorderLayout.CENTER);

        tglBase64Url.setText("Base64Url");
        pnlSecretStatus.add(tglBase64Url, java.awt.BorderLayout.EAST);

        pnlSecret.add(pnlSecretStatus, java.awt.BorderLayout.NORTH);

        pnlJWT.add(pnlSecret, java.awt.BorderLayout.SOUTH);

        add(pnlJWT, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

//    final PropertyChangeListener propertyListener = new PropertyChangeListener() {
//        @Override
//        public void propertyChange(PropertyChangeEvent evt) {
//            ThemeUI.applyStyleTheme(txtHeaderJSON);
//            ThemeUI.applyStyleTheme(txtPayloadJSON);
//            ThemeUI.applyStyleTheme(txtSecretKey);
//        }
//    };

    final DocumentListener documentListener = new DocumentListener() {
        @Override
        public void insertUpdate(DocumentEvent e) {

        }

        @Override
        public void removeUpdate(DocumentEvent e) {

        }

        @Override
        public void changedUpdate(DocumentEvent e) {

        }

    };

//    private org.fife.ui.rtextarea.RTextScrollPane scrollHeaderJSON;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtHeaderJSON;
//
//    private org.fife.ui.rtextarea.RTextScrollPane scrollPayloadJSON;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtPayloadJSON;
//
//    private org.fife.ui.rtextarea.RTextScrollPane scrollSecretKey;
//    private org.fife.ui.rsyntaxtextarea.RSyntaxTextArea txtSecretKey;

    private javax.swing.JScrollPane scrollHeaderJSON;
    private javax.swing.JTextPane txtHeaderJSON;

    private javax.swing.JScrollPane scrollPayloadJSON;
    private javax.swing.JTextPane txtPayloadJSON;

    private javax.swing.JScrollPane scrollSecretKey;
    private javax.swing.JTextArea txtSecretKey;

    private void customizeComponents() {
        /**
         * * UI design start **
         */

        /* Header */
        this.txtHeaderJSON = new javax.swing.JTextPane();
        this.scrollHeaderJSON = new javax.swing.JScrollPane(this.txtHeaderJSON);
        this.txtHeaderJSON.setStyledDocument(new JSONDocument());
//        this.txtHeaderJSON.setLineWrap(true);
//        this.txtHeaderJSON.setWrapStyleWord(false);
//        this.txtHeaderJSON.setCodeFoldingEnabled(true);
//        this.txtHeaderJSON.setClearWhitespaceLinesEnabled(true);
//        this.txtHeaderJSON.setHighlightCurrentLine(false);
//        this.txtHeaderJSON.setCurrentLineHighlightColor(SystemColor.textHighlight);
//        this.txtHeaderJSON.setBackground(SystemColor.text);
        this.txtHeaderJSON.setEditable(true);
//        this.txtHeaderJSON.setSyntaxEditingStyle(SyntaxConstants.SYNTAX_STYLE_JSON);
//        this.txtHeaderJSON.getDocument().addDocumentListener(this.documentListener);

//        scrollURaw.setViewportView(txtURaw);
//        this.scrollHeaderJSON.setLineNumbersEnabled(false);
        this.pnlHeader.add(this.scrollHeaderJSON, java.awt.BorderLayout.CENTER);

        /* Payload */
        this.txtPayloadJSON = new javax.swing.JTextPane();
        this.scrollPayloadJSON = new javax.swing.JScrollPane(this.txtPayloadJSON);
        this.txtPayloadJSON.setStyledDocument(new JSONDocument());
//        this.txtPayloadJSON.setLineWrap(true);
//        this.txtPayloadJSON.setWrapStyleWord(false);
//        this.txtPayloadJSON.setCodeFoldingEnabled(true);
//        this.txtPayloadJSON.setClearWhitespaceLinesEnabled(true);
//        this.txtPayloadJSON.setHighlightCurrentLine(false);
//        this.txtPayloadJSON.setCurrentLineHighlightColor(SystemColor.textHighlight);
        this.txtPayloadJSON.setBackground(SystemColor.text);
        this.txtPayloadJSON.setEditable(true);
//        this.txtPayloadJSON.setSyntaxEditingStyle(SyntaxConstants.SYNTAX_STYLE_JSON);
//        this.txtPayloadJSON.getDocument().addDocumentListener(this.documentListener);

//        scrollURaw.setViewportView(txtURaw);

        this.pnlPayload.add(this.scrollPayloadJSON, java.awt.BorderLayout.CENTER);

        /* Signature */
        this.txtSecretKey = new javax.swing.JTextArea();
        this.scrollSecretKey = new javax.swing.JScrollPane(this.txtSecretKey);
//        this.txtSecretKey.setStyledDocument(new JSONDocument());
        this.txtSecretKey.setLineWrap(true);
        this.txtSecretKey.setWrapStyleWord(false);

//        this.txtSecretKey.setCodeFoldingEnabled(true);
//        this.txtSecretKey.setClearWhitespaceLinesEnabled(true);
//        this.txtSecretKey.setHighlightCurrentLine(false);
//        this.txtSecretKey.setCurrentLineHighlightColor(SystemColor.textHighlight);
        this.txtSecretKey.setBackground(SystemColor.text);
        this.txtSecretKey.setEditable(true);
//        this.txtSecretKey.getDocument().addDocumentListener(this.documentListener);
//        scrollURaw.setViewportView(txtURaw);

//        this.scrollSecretKey.setLineNumbersEnabled(false);

        this.pnlSecret.add(this.scrollSecretKey, java.awt.BorderLayout.CENTER);

//        this.propertyListener.propertyChange(null);
//        ThemeUI.addPropertyChangeListener(propertyListener);

    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel lblHeader;
    private javax.swing.JLabel lblPayload;
    private javax.swing.JLabel lblSecret;
    private javax.swing.JPanel pnlHeader;
    private javax.swing.JPanel pnlJWT;
    private javax.swing.JPanel pnlPayload;
    private javax.swing.JPanel pnlSecret;
    private javax.swing.JPanel pnlSecretStatus;
    private javax.swing.JToggleButton tglBase64Url;
    // End of variables declaration//GEN-END:variables

    private boolean format = true;

    /**
     * @return the format
     */
    public boolean isFormat() {
        return this.format;
    }

    /**
     * @param format the format to set
     */
    public void setFormat(boolean format) {
        this.format = format;
    }

    public JWSToken.Header getHeader() {
        return new JWSToken.Header(JsonToken.encodeBase64UrlSafe(getHeaderJSON(false)));
    }

    public String getHeaderText() {
        return this.txtHeaderJSON.getText();
    }

    public void setHeaderText(String value) {
        this.txtHeaderJSON.setText(value);
    }

    public String getHeaderJSON(boolean pretty) {
        return JsonUtil.prettyJson(this.txtHeaderJSON.getText(), pretty);
    }

    public void setHeaderJSON(String value, boolean pretty) {
        this.txtHeaderJSON.setText(JsonUtil.prettyJson(value, pretty));
    }

    public JWSToken.Payload getPayload() {
        return new JWSToken.Payload(JsonToken.encodeBase64UrlSafe(getPayloadJSON(false)));
    }

    public String getPayloadJSON(boolean pretty) {
        return JsonUtil.prettyJson(this.txtPayloadJSON.getText(), pretty);
    }

    public void setPayloadJSON(String value, boolean pretty) {
        this.txtPayloadJSON.setText(JsonUtil.prettyJson(value, pretty));
    }

    public String getPayloadText() {
        return this.txtPayloadJSON.getText();
    }

    public void setPayloadText(String value) {
        this.txtPayloadJSON.setText(value);
    }

    public void setSecretKey(String value) {
        this.txtSecretKey.setText(value);
    }

    public String getSecretKeyText() {
        return this.txtSecretKey.getText();
    }

    public boolean isBase64URL() {
        return this.tglBase64Url.isSelected();
    }

    public void setBase64URL(boolean enable) {
        this.tglBase64Url.setSelected(enable);
    }

    public boolean isEnableBase64URL() {
        return this.tglBase64Url.isEnabled();
    }

    public void setEnableBase64URL(boolean enable) {
        this.tglBase64Url.setEnabled(enable);
    }

    public SecretKey toSecretKey() {
        if (this.isBase64URL()) {
            return JWSUtil.toSecretKey(JsonToken.decodeBase64UrlSafeByte(this.getSecretKeyText()));
        }
        else {
            return JWSUtil.toSecretKey(this.getSecretKeyText());
        }
    }

    public PrivateKey toPrivateKey() throws PEMException {
        if (this.isBase64URL()) {
            return JWSUtil.toPrivateKey(JsonToken.decodeBase64UrlSafe(this.getSecretKeyText()));
        }
        else {
            return JWSUtil.toPrivateKey(this.getSecretKeyText());
        }
    }

    public PublicKey toPublicKey() throws PEMException {
        return JWSUtil.toPublicKey(this.getSecretKeyText());
    }

    public String signToken() throws SignatureException {
        JWSToken.Header header = this.getHeader();
        JWSToken.Payload payload = this.getPayload();
        try {
            if (JWSToken.SYMMETRIC_KEY.contains(header.getAlgorithm())) {
                JWSToken token = new JWSToken(header, payload);
                byte [] signature = token.sign(this.toSecretKey());
                token.getSignature().setEncodeBase64Url(signature);
                return token.getToken();
            }
            else {
                JWSToken token = new JWSToken(header, payload);
                byte [] signature = token.sign(this.toPrivateKey());
                token.getSignature().setEncodeBase64Url(signature);
                return token.getToken();
            }
        } catch (PEMException ex) {
            throw new SignatureException(ex);
        }
    }

    public void setJWS(JWSToken token) {
        this.setJWS(token, this.format);
    }

    public void setJWS(JWSToken token, boolean format) {
        this.txtHeaderJSON.setText(token.getHeader().toJSON(format));
        this.txtPayloadJSON.setText(token.getPayload().toJSON(format));
        this.txtSecretKey.setText(token.getSignaturePart());
    }

    public void setLineWrap(boolean lineWrap) {
//        this.txtHeaderJSON.setLineWrap(lineWrap);
//        this.txtPayloadJSON.setLineWrap(lineWrap);
        this.txtSecretKey.setLineWrap(lineWrap);
    }

    public void clearJWS() {
        this.txtHeaderJSON.setText("");
        this.txtPayloadJSON.setText("");
        this.txtSecretKey.setText("");
    }

    public boolean isEmptyHeader() {
        return getHeaderText().trim().isEmpty();
    }

    public boolean isValidHeader() {
        try {
            getHeader();
            return !getHeaderText().trim().isEmpty();
        } catch (JsonSyntaxException | IllegalArgumentException ex) {
            return false;
        }
    }

    public boolean isValidPayload() {
        try {
            getPayload();
            return true;
        } catch (JsonSyntaxException | IllegalArgumentException ex) {
            return false;
        }
    }

}
