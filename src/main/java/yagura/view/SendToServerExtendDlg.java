package yagura.view;

import extension.helpers.ConvertUtil;
import extension.helpers.StringUtil;
import extension.helpers.SwingUtil;
import extension.view.base.CustomDialog;
import java.net.Proxy;
import java.util.Properties;
import javax.swing.JOptionPane;
import yagura.model.SendToExtend;

/**
 *
 * @author isayan
 */
public class SendToServerExtendDlg extends CustomDialog {

    /**
     * Creates new form NewDialog
     */
    public SendToServerExtendDlg(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        customizeComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The
     * content of this method is always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        pnlMain = new javax.swing.JPanel();
        pnlCerficate = new javax.swing.JPanel();
        chkIgnoreValidateCertification = new javax.swing.JCheckBox();
        pnlProxy = new javax.swing.JPanel();
        pnlUseProxy = new javax.swing.JPanel();
        rdoCustomClient = new javax.swing.JRadioButton();
        rdoBurpClient = new javax.swing.JRadioButton();
        pnlCustomProxy = new javax.swing.JPanel();
        lblProtocol = new javax.swing.JLabel();
        lblProxyHost = new javax.swing.JLabel();
        lblProxyUser = new javax.swing.JLabel();
        lblProxyPasswd = new javax.swing.JLabel();
        txtProxyPasswd = new javax.swing.JPasswordField();
        txtProxyUser = new javax.swing.JTextField();
        txtProxyHost = new javax.swing.JTextField();
        cmbProtocol = new javax.swing.JComboBox<>();
        lblProxyPort = new javax.swing.JLabel();
        spnProxyPort = new javax.swing.JSpinner();
        pnlApply = new javax.swing.JPanel();
        btnCancel = new javax.swing.JButton();
        btnOK = new javax.swing.JButton();

        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);
            }
        });

        pnlMain.setLayout(new java.awt.BorderLayout());

        pnlCerficate.setBorder(javax.swing.BorderFactory.createTitledBorder("Cerficate"));

        chkIgnoreValidateCertification.setText("ignore Validate Certification");

        javax.swing.GroupLayout pnlCerficateLayout = new javax.swing.GroupLayout(pnlCerficate);
        pnlCerficate.setLayout(pnlCerficateLayout);
        pnlCerficateLayout.setHorizontalGroup(
            pnlCerficateLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCerficateLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(chkIgnoreValidateCertification)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        pnlCerficateLayout.setVerticalGroup(
            pnlCerficateLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCerficateLayout.createSequentialGroup()
                .addComponent(chkIgnoreValidateCertification)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        pnlMain.add(pnlCerficate, java.awt.BorderLayout.SOUTH);

        pnlProxy.setLayout(new java.awt.BorderLayout());

        buttonGroup1.add(rdoCustomClient);
        rdoCustomClient.setSelected(true);
        rdoCustomClient.setText("Use Custom http client");
        rdoCustomClient.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                rdoCustomClientStateChanged(evt);
            }
        });

        buttonGroup1.add(rdoBurpClient);
        rdoBurpClient.setText("Use Burp http client (with burp settings)");
        rdoBurpClient.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rdoBurpClientActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlUseProxyLayout = new javax.swing.GroupLayout(pnlUseProxy);
        pnlUseProxy.setLayout(pnlUseProxyLayout);
        pnlUseProxyLayout.setHorizontalGroup(
            pnlUseProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlUseProxyLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlUseProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rdoCustomClient)
                    .addComponent(rdoBurpClient, javax.swing.GroupLayout.PREFERRED_SIZE, 272, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(234, Short.MAX_VALUE))
        );
        pnlUseProxyLayout.setVerticalGroup(
            pnlUseProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlUseProxyLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(rdoBurpClient)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 7, Short.MAX_VALUE)
                .addComponent(rdoCustomClient)
                .addContainerGap())
        );

        pnlProxy.add(pnlUseProxy, java.awt.BorderLayout.PAGE_START);

        pnlCustomProxy.setBorder(javax.swing.BorderFactory.createTitledBorder("Proxy"));

        lblProtocol.setText("Protocol:");

        lblProxyHost.setText("Host:");

        lblProxyUser.setText("User:");

        lblProxyPasswd.setText("Password:");

        txtProxyPasswd.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtProxyPasswdActionPerformed(evt);
            }
        });

        lblProxyPort.setText("port:");

        spnProxyPort.setModel(new javax.swing.SpinnerNumberModel(8080, 0, 65535, 1));
        spnProxyPort.setEditor(new javax.swing.JSpinner.NumberEditor(spnProxyPort, "#"));

        javax.swing.GroupLayout pnlCustomProxyLayout = new javax.swing.GroupLayout(pnlCustomProxy);
        pnlCustomProxy.setLayout(pnlCustomProxyLayout);
        pnlCustomProxyLayout.setHorizontalGroup(
            pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCustomProxyLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(lblProtocol, javax.swing.GroupLayout.PREFERRED_SIZE, 57, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblProxyHost, javax.swing.GroupLayout.PREFERRED_SIZE, 69, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(pnlCustomProxyLayout.createSequentialGroup()
                        .addGap(10, 10, 10)
                        .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lblProxyPasswd)
                            .addComponent(lblProxyUser))))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cmbProtocol, 0, 247, Short.MAX_VALUE)
                    .addComponent(txtProxyUser)
                    .addComponent(txtProxyPasswd)
                    .addComponent(txtProxyHost))
                .addGap(8, 8, 8)
                .addComponent(lblProxyPort, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(spnProxyPort, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
        pnlCustomProxyLayout.setVerticalGroup(
            pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlCustomProxyLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProtocol)
                    .addComponent(cmbProtocol, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProxyHost)
                    .addComponent(txtProxyHost, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblProxyPort)
                    .addComponent(spnProxyPort, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProxyUser)
                    .addComponent(txtProxyUser, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pnlCustomProxyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProxyPasswd)
                    .addComponent(txtProxyPasswd, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pnlProxy.add(pnlCustomProxy, java.awt.BorderLayout.CENTER);

        pnlMain.add(pnlProxy, java.awt.BorderLayout.PAGE_START);

        getContentPane().add(pnlMain, java.awt.BorderLayout.CENTER);

        pnlApply.setPreferredSize(new java.awt.Dimension(550, 50));

        btnCancel.setText("Cancel");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        btnOK.setText("OK");
        btnOK.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOKActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pnlApplyLayout = new javax.swing.GroupLayout(pnlApply);
        pnlApply.setLayout(pnlApplyLayout);
        pnlApplyLayout.setHorizontalGroup(
            pnlApplyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlApplyLayout.createSequentialGroup()
                .addContainerGap(315, Short.MAX_VALUE)
                .addComponent(btnOK, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(btnCancel, javax.swing.GroupLayout.PREFERRED_SIZE, 95, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
        pnlApplyLayout.setVerticalGroup(
            pnlApplyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlApplyLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlApplyLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnCancel)
                    .addComponent(btnOK))
                .addContainerGap(20, Short.MAX_VALUE))
        );

        getContentPane().add(pnlApply, java.awt.BorderLayout.SOUTH);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private final java.util.ResourceBundle BUNDLE = java.util.ResourceBundle.getBundle("yagura/resources/Resource");

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        this.setModalResult(JOptionPane.CANCEL_OPTION);
        this.closeDialog(null);
    }//GEN-LAST:event_btnCancelActionPerformed

    private void btnOKActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOKActionPerformed
        String proxyProtocol = (String)this.cmbProtocol.getSelectedItem();
        String proxyHost = this.txtProxyHost.getText().trim();
        if (!Proxy.Type.DIRECT.name().equals(proxyProtocol)) {
            if (proxyHost.isEmpty()) {
                JOptionPane.showMessageDialog(this, BUNDLE.getString("view.sendto.add.proxyhost.empty"), "SendTo", JOptionPane.INFORMATION_MESSAGE);
            }
            else {
                this.setModalResult(JOptionPane.OK_OPTION);
                this.closeDialog(null);
            }
        } else {
            this.setModalResult(JOptionPane.OK_OPTION);
            this.closeDialog(null);
        }
    }//GEN-LAST:event_btnOKActionPerformed

    private void txtProxyPasswdActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtProxyPasswdActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtProxyPasswdActionPerformed

    private void rdoBurpClientActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rdoBurpClientActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_rdoBurpClientActionPerformed

    private void rdoCustomClientStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_rdoCustomClientStateChanged
        SwingUtil.setContainerEnable(pnlCustomProxy, this.rdoCustomClient.isSelected());
    }//GEN-LAST:event_rdoCustomClientStateChanged

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                SendToServerExtendDlg dialog = new SendToServerExtendDlg(new java.awt.Frame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnOK;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JCheckBox chkIgnoreValidateCertification;
    private javax.swing.JComboBox<String> cmbProtocol;
    private javax.swing.JLabel lblProtocol;
    private javax.swing.JLabel lblProxyHost;
    private javax.swing.JLabel lblProxyPasswd;
    private javax.swing.JLabel lblProxyPort;
    private javax.swing.JLabel lblProxyUser;
    private javax.swing.JPanel pnlApply;
    private javax.swing.JPanel pnlCerficate;
    private javax.swing.JPanel pnlCustomProxy;
    private javax.swing.JPanel pnlMain;
    private javax.swing.JPanel pnlProxy;
    private javax.swing.JPanel pnlUseProxy;
    private javax.swing.JRadioButton rdoBurpClient;
    private javax.swing.JRadioButton rdoCustomClient;
    private javax.swing.JSpinner spnProxyPort;
    private javax.swing.JTextField txtProxyHost;
    private javax.swing.JPasswordField txtProxyPasswd;
    private javax.swing.JTextField txtProxyUser;
    // End of variables declaration//GEN-END:variables

    @SuppressWarnings("unchecked")
    private void customizeComponents() {
        this.cmbProtocol.addItem(Proxy.Type.DIRECT.name());
        this.cmbProtocol.addItem(Proxy.Type.HTTP.name());
        this.cmbProtocol.addItem(Proxy.Type.SOCKS.name());
    }

    public void setProperties(Properties prop) {
        String proxyProtocol = prop.getProperty("proxyProtocol", Proxy.Type.DIRECT.name());
        String proxyHost = prop.getProperty("proxyHost", "");
        String proxyPort = prop.getProperty("proxyPort", "8080");
        String proxyUser = prop.getProperty("proxyUser", "");
        String proxyPasswd = prop.getProperty("proxyPasswd", "");
        String ignoreValidateCertification = prop.getProperty("ignoreValidateCertification", Boolean.TRUE.toString());
        String useProxy = prop.getProperty("useProxy", SendToExtend.USE_CUSTOM_PROXY);
        this.cmbProtocol.setSelectedItem(proxyProtocol);
        this.txtProxyHost.setText(proxyHost);
        this.spnProxyPort.setValue((int)ConvertUtil.parseIntDefault(proxyPort, 8080));
        this.txtProxyUser.setText(proxyUser);
        this.txtProxyPasswd.setText(proxyPasswd);
        if (SendToExtend.USE_CUSTOM_PROXY.equals(useProxy)) {
            this.rdoCustomClient.setSelected(true);
        }
        else {
            this.rdoBurpClient.setSelected(true);
        }
        this.chkIgnoreValidateCertification.setSelected(ConvertUtil.parseBooleanDefault(ignoreValidateCertification, false));
    }

    public void getProperties(Properties prop) {
        prop.setProperty("proxyProtocol", (String)this.cmbProtocol.getSelectedItem());
        prop.setProperty("proxyHost", this.txtProxyHost.getText());
        prop.setProperty("proxyPort", StringUtil.toString(this.spnProxyPort.getValue()));
        prop.setProperty("proxyUser", this.txtProxyUser.getText());
        prop.setProperty("proxyPasswd", String.valueOf(this.txtProxyPasswd.getPassword()));
        String useProxy = this.rdoCustomClient.isSelected() ? SendToExtend.USE_CUSTOM_PROXY : SendToExtend.USE_BURP_PROXY;
        prop.setProperty("useProxy", useProxy);
        prop.setProperty("ignoreValidateCertification", String.valueOf(this.chkIgnoreValidateCertification.isSelected()));
    }


}
